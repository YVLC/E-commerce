@page "/basket"
@using DataEntities
@using Store.Services
@inject BasketService BasketService
@inject OrderingService OrderingService
@inject PaymentService PaymentService

<h1>Your Basket</h1>

@if (basketItems.Count == 0)
{
    <p>@message</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in basketItems)
            {
                <tr>
                    <td>@item.Name</td>
                    <td>@item.Price.ToString("0.00")</td>
                    <td>@item.Quantity</td>
                    <td>@(item.Price * item.Quantity)</td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3"><strong>Grand Total:</strong></td>
                <td><strong>@basketItems.Sum(i => i.Price * i.Quantity).ToString("0.00")</strong></td>
            </tr>
        </tfoot>
    </table>

    <!-- Payment Method Selection -->

    <!-- Place Order Form -->
    <form @formname="checkout" @onsubmit="PlaceOrder" method="post">
        <div class="form-group">
            <label>Select Payment Method:</label>
            <select class="form-control" @bind="selectedPaymentMethod">
                <option value="Card">Card</option>
                <option value="PayPal">PayPal</option>
            </select>
        </div>
        <AntiforgeryToken />
        <div class="form-group">
            <label for="cardNumber">Card Number:</label>
            <InputText type="text" class="form-control" id="cardNumber" @bind-Value="cardNumber" placeholder="Enter your card number" />
        </div>
        <button type="submit" class="btn btn-primary">Place Order</button>
    </form>

    @if (orderSuccess)
    {
        <p class="text-success">Order placed successfully!</p>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="text-danger">@errorMessage</p>
    }
}

@code {
    private List<BasketItem> basketItems = new();
    private bool orderSuccess = false;
    private string? errorMessage;
    private Guid orderNumber = Guid.NewGuid();
    private string message = "Your basket is empty.";

    // Bind directly with @bind for parameters
    private string selectedPaymentMethod = "Card";  // Default selection

    [SupplyParameterFromForm]
    private string cardNumber { get; set; } = string.Empty;    // Card number for Card payments

    protected override async Task OnInitializedAsync()
    {
        // Example of getting basket items
        basketItems = await BasketService.GetBasketItemsAsync();
    }

    private async Task PlaceOrder()
    {
        try
        {
            // Validation of card number (if necessary)
            if (selectedPaymentMethod == "Card" && string.IsNullOrEmpty(cardNumber))
            {
                errorMessage = "Please enter a valid card number.";
                return;
            }

            orderSuccess = false;
            errorMessage = null;

            // Create order items from the basket
            var orderItems = basketItems.Select(item => new Store.Services.OrderItem(
                Id: item.ProductId,
                ProductName: item.Name,
                UnitPrice: item.Price,
                Units: item.Quantity,
                PictureUrl: item.PictureUrl
            )).ToArray();

            var orderRecord = new OrderRecord(
                OrderNumber: orderNumber,
                Date: DateTime.UtcNow,
                Status: "Pending",
                City: "Sample City",
                Country: "Sample Country",
                Street: "Sample Street",
                Total: basketItems.Sum(i => i.Price * i.Quantity),
                OrderItems: orderItems
            );

            var requestId = Guid.NewGuid();

            // Create the order
            await OrderingService.CreateOrder(orderRecord, requestId);

            // Simulate payment transaction creation based on the selected payment method
            var paymentResult = await ProcessPayment();

            if (paymentResult)
            {
                // Clear the basket after successful order and payment
                basketItems.Clear();
                await BasketService.ClearBasketAsync();
                orderSuccess = true;
                message = "successful";
            }
            else
            {
                errorMessage = "Payment failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to place the order: {ex.Message}";
        }
    }

    private async Task<bool> ProcessPayment()
    {
        // Simulate payment logic based on selected payment method
        if (selectedPaymentMethod == "Card")
        {
            // Call the PaymentService for card payment
            return await PaymentService.CreatePayment(new Payment
                {
                    PaymentMethod = "Card",
                    orderid = orderNumber,
                    amount = basketItems.Sum(i => i.Price * i.Quantity),
                    paymentstatus = "pending",
                    CardNumber = cardNumber,
                    date = DateTime.UtcNow
                });
        }
        else if (selectedPaymentMethod == "PayPal")
        {
            // Call the PaymentService for PayPal payment
            return await PaymentService.CreatePayment(new Payment
                {
                    PaymentMethod = "PayPal"
                });
        }

        return false; // Default fail if no valid payment method selected
    }
}